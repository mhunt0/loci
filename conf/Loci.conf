SYS_TYPE			:=	$(shell uname -s | sed "s/ //g" | sed "s/[-.]/_/g")
ARCH_TYPE			:=	$(shell uname -m | sed "s/ //g")
LOCI_REV			=	'$Name: rel-4-0-p10 $'
COMP_NAME			=	$(shell echo $(CXX) | sed -e 's/ .*//' -e 's/.*\///')
LOCI_REV1			=	$(shell echo "$(LOCI_REV)"| sed -e 's/.*: *//' -e 's/ *\$$//' -e 's/ //g')
LOCI_REVISION_NAME	=	$(shell if [ -n "$(LOCI_REV1)" ]; then echo "$(LOCI_REV1)"; else date +%m.%d.%y;fi)
LOCI_RPATH			=	$(LOCI_BASE)/lib
uniq				=	$(if $1,$(firstword $1) $(call uniq,$(filter-out $(firstword $1),$1)))

include $(LOCI_SRC)/sys.conf
include $(LOCI_SRC)/comp.conf

export LD_LIBRARY_PATH:=$(LOCI_SRC)/lib:$(LD_LIBRARY_PATH)
export DYLD_LIBRARY_PATH:=$(LOCI_SRC)/lib:$(DYLD_LIBRARY_PATH)

# Loci Preprocessor
LPP	=	$(LOCI_SRC)/bin/lpp

# Setup library suffix
ifeq ($(SYS_TYPE),Darwin)
LIB_SUFFIX	=	dylib
COPY		=	rsync -L
ESC			=	\\033[
ECHO		=	echo
SED_I		=	sed -i ''
else
LIB_SUFFIX	=	so
COPY		=	cp
ECHO		=	echo -e
ESC			=	\e[
SED_I		=	sed -i
endif
PRT			=	$(ESC)1;33;44m
NC			=	$(ESC)0m

DEFINES			=	$(MACHINE_DEFINES)     \
					$(SYSTEM_DEFINES)      \
					-DLOCI_SYS_$(SYS_TYPE) \
					-DLOCI_ARCH_$(ARCH_TYPE) \
					$(DEBUG_DEFINES)
LOCI_INCLUDES	=	-I$(LOCI_SRC)/include $(MACHINE_INCLUDES)
LDPATH			+=	$(RPATH)$(LOCI_RPATH)
LDFLAGS			+=	-L$(LOCI_SRC)/lib \
					$(BASE_LDFLAGS) \
					$(DEBUG)
LDLIBS			=	$(call uniq,   \
					-lLoci         \
					-lTools        \
					$(BASE_LIBS)   \
					-lm            \
					-lsprng)

FLAGS			=	$(DEBUG) $(PIC_FLAGS) $(ARCH_FLAGS_$(ARCH_TYPE))
FFLAGS			=	$(FLAGS) $(F_OPT)
CFLAGS			=	$(FLAGS) $(C_OPT)
CXXFLAGS		=	$(FLAGS) $(CXX_OPT)

.SUFFIXES: .o .lo .c .cc .C .f90

%.cc : %.loci
	$(LPP) $(LOCI_INCLUDES) $(INCLUDES) $< -o $@

################################################################################
# Recipes for generating library object files
################################################################################
%_lo.o : %.c
	$(CC) $(CFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -o  $@ -c $<

%_lo.o : %.cc
	$(CXX) $(CXXFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -o $@ -c $<

%_lo.o : %.C
	$(CXX) $(CXXFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -o $@ -c $<

%_lo.o : %.cpp
	$(CXX) $(CXXFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -o $@ -c $<

%_lo.o : %.cu
	$(NVCC) $(PIC_FLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -o $@ -c $<

%_lo.o: %.f90
	$(FC) $(FFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -o $@ -c $<

################################################################################
# Recipes for generating FAD object files
################################################################################
%_FAD.o : %.c
	$(CC) $(CFLAGS) $(DEFINES) $(FAD_DEFINES) $(LOCI_INCLUDES) $(INCLUDES) \
		-o  $@ -c $<

%_FAD.o : %.cc
	$(CXX) $(CXXFLAGS) $(DEFINES) $(FAD_DEFINES) $(LOCI_INCLUDES) $(INCLUDES) \
		-o $@ -c $<

%_FAD.o : %.C
	$(CXX) $(CXXFLAGS) $(DEFINES) $(FAD_DEFINES) $(LOCI_INCLUDES) $(INCLUDES) \
		-o $@ -c $<

%_FAD.o : %.cpp
	$(CXX) $(CXXFLAGS) $(DEFINES) $(FAD_DEFINES) $(LOCI_INCLUDES) $(INCLUDES) \
		-o $@ -c $<

%_FAD.o : %.cu
	$(NVCC) $(PIC_FLAGS) $(DEFINES) $(FAD_DEFINES) $(LOCI_INCLUDES) $(INCLUDES) \
		-o $@ -c $<

%_FAD.o: %.f90
	$(FC) $(FFLAGS) $(DEFINES) $(FAD_DEFINES) $(LOCI_INCLUDES) $(INCLUDES) \
		-o $@ -c $<


################################################################################
# Recipes for generating object files
################################################################################
%.o: %.c
	$(CC) $(CFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -c -o $@ $<

%.o: %.cc
	$(CXX) $(CXXFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -c -o $@ $<

%.o: %.C
	$(CXX) $(CFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -c -o $@ $<

%.o: %.cpp
	$(CXX) $(CXXFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -c -o $@ $<

%.o: %.cu
	$(NVCC) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -c -o $@ $<

%.o: %.f90
	$(FC) $(FFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) -c -o $@ $<


################################################################################
# Recipes for generating dependencies from source files
################################################################################
%.d: %.c
	set -e; $(CC) -M $(CFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) $< \
	| sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' > $@; \
		[ -s $@ ] || rm -f $@
%.d: %.C
	set -e; $(MAKEDEPEND) $(CFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) $< \
	| sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' > $@; \
		[ -s $@ ] || rm -f $@
%.d: %.cc
	set -e; $(MAKEDEPEND) $(CXXFLAGS) $(DEFINES) $(LOCI_INCLUDES) $(INCLUDES) $< \
	| sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' > $@; \
		[ -s $@ ] || rm -f $@
%.d: %.cpp
	set -e; $(MAKEDEPEND) $(CXXFLAGS) $(EFINES) $(LOCI_INCLUDES) $(INCLUDES) $< \
	| sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' > $@; \
		[ -s $@ ] || rm -f $@

# This creates a directory if it doesn't exist. Used mostly with install definitions
%/.:
	mkdir -p -- "$*"

#HACK for now
%.d: %.f90
	echo -n > $@
